<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head('Valorant Weapon Store')}">
</head>

<body class="bg-valorant-base text-valorant-text-primary min-h-screen flex flex-col items-center p-5">

    <div th:replace="~{fragments/header :: header('Daily Store', true)}"></div>

    <div id="loading" class="text-2xl text-valorant-text-secondary mt-12 animate-pulse">Loading Store...</div>
    <div id="error" class="text-valorant-red text-xl text-center hidden"></div>
    <div id="weapons-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full max-w-7xl p-2"></div>

    <div th:replace="~{fragments/modal :: video-modal}"></div>
    <div th:replace="~{fragments/scripts :: common-scripts}"></div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', async () => {
            const app = initApp();
            if (!app) return;
            if (app.error) {
                const errorEl = document.getElementById('error');
                const loadingEl = document.getElementById('loading');
                loadingEl.classList.add('hidden');
                errorEl.textContent = app.error;
                errorEl.classList.remove('hidden');
                setTimeout(logout, 2000);
                return;
            }

            const { puuid, accessToken, entitlementsToken } = app;
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const gridEl = document.getElementById('weapons-grid');

            // Fetch Header Data
            fetchPlayerInfo(puuid, accessToken, entitlementsToken);
            fetchWallet(puuid, accessToken, entitlementsToken);

            try {
                const responseWeaponSkins = await fetch(`/api/riot-valo/storefront/${puuid}/daily-store`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Entitlements-Token': entitlementsToken,
                        'Region': 'ap'
                    }
                });

                if (!responseWeaponSkins.ok) {
                    if (responseWeaponSkins.status === 401 || responseWeaponSkins.status === 403) {
                        logout();
                        return;
                    }
                    throw new Error(`Failed to fetch skins: ${responseWeaponSkins.status}`);
                }

                const jsonResponse = await responseWeaponSkins.json();
                const skins = jsonResponse.items || jsonResponse.data?.items;
                const expireAt = jsonResponse.expireAt || jsonResponse.data?.expireAt;

                if (expireAt) {
                    const countdownEl = document.getElementById('store-countdown');
                    const updateCountdown = () => {
                        const now = Math.floor(Date.now() / 1000);
                        let diff = expireAt - now;
                        if (diff <= 0) {
                            countdownEl.textContent = "EXPIRED";
                            return;
                        }
                        const hours = Math.floor(diff / 3600);
                        const minutes = Math.floor((diff % 3600) / 60);
                        const seconds = diff % 60;
                        countdownEl.textContent = "Refreshes in: " +
                            [hours, minutes, seconds].map(v => v < 10 ? "0" + v : v).join(":");
                    };
                    updateCountdown();
                    setInterval(updateCountdown, 1000);
                }

                loadingEl.classList.add('hidden');

                if (!skins || skins.length === 0) {
                    errorEl.textContent = 'No available skins found in the store.';
                    errorEl.classList.remove('hidden');
                    return;
                }

                skins.forEach(skin => {
                    const card = document.createElement('div');
                    card.className = 'bg-valorant-card rounded overflow-hidden relative border border-white/10 hover:-translate-y-1 hover:shadow-2xl hover:border-valorant-red transition-all duration-300 group';

                    const displayName = skin.displayName || 'Unknown Skin';
                    const displayIcon = skin.displayIcon || '';
                    const cost = skin.cost || 'N/A';
                    const costIcon = skin.costIcon || 'https://media.valorant-api.com/currencies/85ad13f7-3d1b-5128-9eb2-7cd8ee0b5741/displayicon.png';
                    const videoUrl = skin.streamedVideo;

                    let videoButtonHtml = '';
                    if (skin.levels && skin.levels.length > 0) {
                        let buttons = '';
                        skin.levels.forEach((level, index) => {
                            if (level.streamedVideo) {
                                let btnLabel = 'L' + (index + 1);
                                const match = level.displayName?.match(/Level (\d+)/i);
                                if (match) btnLabel = 'L' + match[1];
                                buttons += `<button onclick="openVideo('${level.streamedVideo}')" class="inline-block mr-1 mb-1 w-6 h-6 flex items-center justify-center bg-white/5 border border-white/20 text-white text-xs font-bold hover:bg-valorant-red hover:border-valorant-red transition-all duration-200" title="${level.displayName || 'Level ' + (index + 1)}">${btnLabel}</button>`;
                            }
                        });
                        if (buttons) {
                            videoButtonHtml = `<div><p class="text-xs text-valorant-text-secondary uppercase mb-2 font-bold tracking-wider">Levels</p><div class="flex flex-wrap">${buttons}</div></div>`;
                        } else if (skin.streamedVideo) {
                            videoButtonHtml = `<button onclick="openVideo('${skin.streamedVideo}')" class="inline-block px-6 py-2 bg-valorant-red text-white text-sm md:text-lg font-bold uppercase tracking-wider hover:bg-red-700 transition-colors duration-300 rounded shadow-lg shadow-valorant-red/20">Watch Video</button>`;
                        }
                    } else if (videoUrl) {
                        videoButtonHtml = `<button onclick="openVideo('${videoUrl}')" class="inline-block px-6 py-2 bg-valorant-red text-white text-sm md:text-lg font-bold uppercase tracking-wider hover:bg-red-700 transition-colors duration-300 rounded shadow-lg shadow-valorant-red/20">Watch Video</button>`;
                    }

                    let chromaHtml = '';
                    if (skin.chromas && skin.chromas.length > 0) {
                        let swatches = '';
                        skin.chromas.forEach(chroma => {
                            if (chroma.swatch) {
                                swatches += `<img loading="lazy" src="${chroma.swatch}" alt="${chroma.displayName}" class="w-6 h-6 rounded border border-white/20 hover:border-valorant-red cursor-pointer transition-all duration-200" onclick="changeCardImage(this, '${chroma.displayIcon}')" title="${chroma.displayName}">`;
                            }
                        });
                        if (swatches) chromaHtml = `<div><p class="text-xs text-valorant-text-secondary uppercase mb-2 font-bold tracking-wider">Variants</p><div class="flex flex-wrap gap-2">${swatches}</div></div>`;
                    }

                    let tierHtml = skin.tier?.displayIcon ? `<img loading="lazy" src="${skin.tier.displayIcon}" class="absolute top-3 right-3 w-10 h-10 drop-shadow-md z-10" title="${skin.tier.displayName}">` : '';

                    card.innerHTML = `
                        <div class="relative h-48 flex items-center justify-center p-6 bg-gradient-to-br from-white/5 to-transparent group/img">
                            ${tierHtml}
                            <img loading="lazy" src="${skin.displayIcon}" alt="${skin.displayName}" class="card-main-image max-w-full max-h-full object-contain transition-all duration-500 group-hover:scale-110 drop-shadow-2xl" onerror="this.src='https://placehold.co/400x200?text=Weapon+Skin'">
                        </div>
                        <div class="p-5">
                            <div class="text-xl font-bold mb-2 uppercase text-valorant-text-primary tracking-wide leading-tight min-h-[3.5rem]">${displayName}</div>
                            <div class="flex items-center text-base text-valorant-text-secondary mb-3">
                                <span class="w-5 h-5 mr-2 rounded-full flex items-center justify-center text-xs text-white font-bold"><img loading="lazy" src="${costIcon}" alt="vp" class="w-5 h-5"></span> ${cost}
                            </div>
                            <div class="flex justify-between items-start gap-4 mt-4 min-h-[50px]">
                                <div class="flex-1">${chromaHtml}</div>
                                <div class="flex-1 flex justify-end">${videoButtonHtml}</div>
                            </div>
                        </div>
                    `;
                    gridEl.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                loadingEl.classList.add('hidden');
                errorEl.textContent = 'Error loading store: ' + err.message;
                errorEl.classList.remove('hidden');
            }
        });
    </script>
</body>

</html>
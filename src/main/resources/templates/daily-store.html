<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Valorant Weapon Store')">
</head>
<body class="bg-valorant-base text-valorant-text-primary min-h-screen flex flex-col items-center p-5">

    <div th:replace="fragments/header :: header('Daily Store', true)"></div>

    <div id="loading" class="text-2xl text-valorant-text-secondary mt-12 animate-pulse">Loading Store...</div>
    <div id="error" class="text-valorant-red text-xl text-center hidden"></div>
    <div id="weapons-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full max-w-7xl p-2"></div>

    <div id="video-modal">
        <div id="video-content-wrapper">
            <button id="modal-close-btn" onclick="closeVideo()">
                <span>Close</span>
                <span style="font-size: 1.5em; line-height: 1;">&times;</span>
            </button>
            <div class="relative pt-[56.25%] bg-black rounded-lg overflow-hidden group" style="position: relative; padding-top: 56.25%;">
                <!-- Loading Spinner -->
                <div id="video-loader">
                     <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-valorant-red" style="border-top-color: #ff4655; border-bottom-color: #ff4655;"></div>
                </div>
                <!-- Video Element -->
                <video id="modal-video" controls autoplay style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('logout-btn').addEventListener('click', () => {
            logout();
        });

        function changeCardImage(el, newSrc) {
            // Find the main image within the same card
            const card = el.closest('.group'); // Assuming .group is on the card wrapper
            if (card) {
                const img = card.querySelector('.card-main-image');
                if (img) {
                    img.style.opacity = '0';
                    setTimeout(() => {
                         img.src = newSrc;
                         img.onload = () => { img.style.opacity = '1'; };
                         // Handle cached images
                         if (img.complete) { img.style.opacity = '1'; }
                    }, 200);
                }
            }
        }

        function logout() {
            localStorage.removeItem('valorant_puuid');
            localStorage.removeItem('valorant_access_token');
            localStorage.removeItem('valorant_entitlements_token');
            window.location.href = '/?logout=true';
            return;
        }

        function openVideo(url) {
            const modal = document.getElementById('video-modal');
            const video = document.getElementById('modal-video');
            const loader = document.getElementById('video-loader');
            
            // Show loader initially
            loader.style.display = 'flex';
            
            video.src = url;
            
            // Event listeners for loading state
            video.onwaiting = () => { loader.style.display = 'flex'; };
            video.onplaying = () => { loader.style.display = 'none'; };
            video.oncanplay = () => { loader.style.display = 'none'; };
            video.onloadstart = () => { loader.style.display = 'flex'; };

            modal.classList.add('active');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeVideo();
                }
            };
        }

        function closeVideo() {
            const modal = document.getElementById('video-modal');
            const video = document.getElementById('modal-video');
            video.pause();
            video.src = '';
            
            // Remove event listeners
            video.onwaiting = null;
            video.onplaying = null;
            video.oncanplay = null;
            video.onloadstart = null;
            
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            let puuid = urlParams.get('puuid');
            const puuidStored = localStorage.getItem('valorant_puuid');
            
            const accessToken = localStorage.getItem('valorant_access_token');
            const entitlementsToken = localStorage.getItem('valorant_entitlements_token');
            // Check for tokens
            if (!accessToken || !entitlementsToken) {
                logout();
                return;
            }

            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const gridEl = document.getElementById('weapons-grid');

            if (!puuid) {
                if (!puuidStored) {
                    loadingEl.style.display = 'none';
                    errorEl.textContent = 'User ID (puuid) is missing from the URL.';
                    errorEl.style.display = 'block';
                    setInterval(() => {
                        logout();
                    }, 2000);
                    return;
                }
                puuid = puuidStored;
            }

            const nightMarketBtn = document.getElementById('night-market-btn');
            if (nightMarketBtn) {
                nightMarketBtn.href = `/stores/night-market?puuid=${puuid}`;
            }

            try {

                const responsePlayers = await fetch(`/api/riot-valo/players/${puuid}`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Entitlements-Token': entitlementsToken,
                        'Region': 'ap'
                    }
                });

                if (!responsePlayers.ok) {
                    if (responsePlayers.status === 401 || responsePlayers.status === 403) {
                        logout();
                        return;
                    }
                }

                const jsonResponsePlayers = await responsePlayers.json();
                const playerName = jsonResponsePlayers.data?.[0]?.GameName;
                const playerTagline = jsonResponsePlayers.data?.[0]?.TagLine;

                if (playerName && playerTagline) {
                    document.getElementById('player-name').textContent = playerName;
                    document.getElementById('player-tagline').textContent = '#' + playerTagline;
                }

                // Fetch Wallet
                try {
                    const responseWallet = await fetch(`/api/riot-valo/wallet/${puuid}`, {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Entitlements-Token': entitlementsToken,
                            'Region': 'ap'
                        }
                    });

                    if (responseWallet.ok) {
                        const jsonWallet = await responseWallet.json();
                        const balances = jsonWallet.Balances || jsonWallet.data?.Balances;
                        if (balances) {
                             const vp = balances["85ad13f7-3d1b-5128-9eb2-7cd8ee0b5741"] || 0;
                             const rp = balances["e59aa87c-4cbf-517a-5983-6e81511be9b7"] || 0;
                             const kc = balances["85ca954a-41f2-ce94-9b45-8ca3dd309006"] || 0;

                             document.getElementById('wallet-vp').textContent = vp.toLocaleString();
                             document.getElementById('wallet-rp').textContent = rp.toLocaleString();
                             document.getElementById('wallet-kc').textContent = kc.toLocaleString();
                             
                             const walletContainer = document.getElementById('wallet-container');
                             walletContainer.classList.remove('hidden');
                             walletContainer.classList.add('flex');
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch wallet:", e);
                }

                const responseWeaponSkins = await fetch(`/api/riot-valo/storefront/${puuid}/daily-store`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Entitlements-Token': entitlementsToken,
                        'Region': 'ap'
                    }
                });
                
                if (!responseWeaponSkins.ok) {
                    if (responseWeaponSkins.status === 401 || responseWeaponSkins.status === 403) {
                        logout();
                        return;
                    }
                    throw new Error(`Failed to fetch skins: ${responseWeaponSkins.status} ${responseWeaponSkins.statusText}`);
                }

                const jsonResponse = await responseWeaponSkins.json();
                const skins = jsonResponse.items || jsonResponse.data?.items;
                const expireAt = jsonResponse.expireAt || jsonResponse.data?.expireAt;
                
                if (expireAt) {
                    const startCountdown = () => {
                        const now = Math.floor(Date.now() / 1000);
                        let diff = expireAt - now;

                        if (diff <= 0) {
                            document.getElementById('store-countdown').textContent = "EXPIRED";
                            return;
                        }

                        const hours = Math.floor(diff / 3600);
                        const minutes = Math.floor((diff % 3600) / 60);
                        const seconds = diff % 60;

                        const formatted = 
                            (hours < 10 ? "0" + hours : hours) + ":" + 
                            (minutes < 10 ? "0" + minutes : minutes) + ":" + 
                            (seconds < 10 ? "0" + seconds : seconds);
                       
                        document.getElementById('store-countdown').textContent = "Refreshes in: " + formatted;
                    };
                    
                    startCountdown(); // Initial call
                    setInterval(startCountdown, 1000);
                }

                loadingEl.style.display = 'none';

                if (!skins || skins.length === 0) {
                    errorEl.textContent = 'No available skins found in the store.';
                    errorEl.style.display = 'block';
                    return;
                }

                skins.forEach(skin => {
                    const card = document.createElement('div');
                    card.className = 'bg-valorant-card rounded overflow-hidden relative border border-white/10 hover:-translate-y-1 hover:shadow-2xl hover:border-valorant-red transition-all duration-300 group';
                    
                    // Fallback for null values
                    const displayName = skin.displayName || 'Unknown Skin';
                    const displayIcon = skin.displayIcon || ''; // Should handle empty icon
                    const cost = skin.cost || 'N/A';
                    const costIcon = skin.costIcon || 'vp';
                    const videoUrl = skin.streamedVideo;

                    let videoButtonHtml = '';
                    
                    // Levels
                    if (skin.levels && skin.levels.length > 0) {
                        let buttons = '';
                        skin.levels.forEach((level, index) => {
                            if (level.streamedVideo) {
                                let btnLabel = 'L' + (index + 1);
                                if (level.displayName) {
                                     const match = level.displayName.match(/Level (\d+)/i);
                                     if (match) {
                                         btnLabel = 'L' + match[1];
                                     }
                                }
                                
                                buttons += `<button onclick="openVideo('${level.streamedVideo}')" class="inline-block mr-2 mb-2 w-6 h-6 flex items-center justify-center bg-white/5 border border-white/20 text-white text-xs font-bold hover:bg-valorant-red hover:border-valorant-red transition-all duration-200" title="${level.displayName || 'Level ' + (index + 1)}">${btnLabel}</button>`;
                            }
                        });
                        
                        if (buttons) {
                             videoButtonHtml = `<div><p class="text-xs text-valorant-text-secondary uppercase mb-2 font-bold tracking-wider">Levels</p><div class="flex flex-wrap">${buttons}</div></div>`;
                        } else if (skin.streamedVideo) {
                             videoButtonHtml = `<button onclick="openVideo('${skin.streamedVideo}')" class="inline-block px-6 py-2 bg-valorant-red text-white text-sm md:text-lg font-bold uppercase tracking-wider hover:bg-red-700 transition-colors duration-300 rounded shadow-lg shadow-valorant-red/20">Watch Video</button>`;
                        }
                    } else if (videoUrl) {
                        videoButtonHtml = `<button onclick="openVideo('${videoUrl}')" class="inline-block px-6 py-2 bg-valorant-red text-white text-sm md:text-lg font-bold uppercase tracking-wider hover:bg-red-700 transition-colors duration-300 rounded shadow-lg shadow-valorant-red/20">Watch Video</button>`;
                    }

                    // Chromas
                    let chromaHtml = '';
                    if (skin.chromas && skin.chromas.length > 0) {
                        let swatches = '';
                        skin.chromas.forEach(chroma => {
                            if (chroma.swatch) {
                                 swatches += `<img loading="lazy" src="${chroma.swatch}" alt="${chroma.displayName}" class="w-6 h-6 rounded border border-white/20 hover:border-valorant-red cursor-pointer transition-all duration-200" onclick="changeCardImage(this, '${chroma.displayIcon}')" title="${chroma.displayName}">`;
                            }
                        });
                        if (swatches) {
                            chromaHtml = `<div><p class="text-xs text-valorant-text-secondary uppercase mb-2 font-bold tracking-wider">Variants</p><div class="flex flex-wrap gap-2">${swatches}</div></div>`;
                        }
                    }

                    // Tier
                    let tierHtml = '';
                    if (skin.tier && skin.tier.displayIcon) {
                        tierHtml = `<img loading="lazy" src="${skin.tier.displayIcon}" class="absolute top-3 right-3 w-10 h-10 drop-shadow-md z-10" title="${skin.tier.displayName}">`;
                    }

                    card.innerHTML = `
                        <div class="relative w-full h-48 flex items-center justify-center bg-gradient-to-br from-[#2c353e] to-[#1c252e] p-4 overflow-hidden">
                            ${tierHtml}
                            <img loading="lazy" src="${displayIcon}" alt="${displayName}" class="card-main-image max-w-full max-h-full object-contain drop-shadow-xl transition-transform duration-300 group-hover:scale-110 group-hover:-rotate-2" onerror="this.src='https://placehold.co/400x300'">
                        </div>
                        <div class="p-5">
                            <div class="text-xl font-bold mb-2 uppercase text-valorant-text-primary tracking-wide leading-tight min-h-[3.5rem]">${displayName}</div>
                            <div class="flex items-center text-base text-valorant-text-secondary mb-3">
                                <span class="w-5 h-5 mr-2 rounded-full flex items-center justify-center text-xs text-white font-bold"><img loading="lazy" src="${costIcon}" alt="vp" class="w-5 h-5"></span> ${cost}
                            </div>

                            <div class="flex justify-between items-start gap-4 mt-4 min-h-[50px]">
                                <div class="flex-1">
                                    ${chromaHtml}
                                </div>
                                <div class="flex-1 flex justify-end">
                                    ${videoButtonHtml}
                                </div>
                            </div>

                        </div>
                    `;
                    gridEl.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Error loading store: ' + err.message;
                errorEl.style.display = 'block';
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head('Valorant Match History')}">
</head>

<body class="bg-valorant-base text-valorant-text-primary min-h-screen flex flex-col items-center p-5">

    <div th:replace="~{fragments/header :: header('Match History', false)}"></div>
    <div id="match-controls" class="w-full max-w-5xl flex justify-center md:justify-end items-center mb-6 px-2">
        <button id="refresh-matches-btn"
            class="flex md:justify-end-safe gap-2 px-4 py-2 bg-valorant-card border border-white/10 hover:border-valorant-red text-white text-sm font-bold uppercase tracking-widest rounded transition-all duration-300 hover:bg-valorant-red/10 active:scale-95 group">
            <svg id="refresh-icon" class="w-4 h-4 transition-transform duration-500 group-hover:rotate-180" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
            </svg>
            <span id="refresh-text">Refresh History</span>
        </button>
    </div>


    <div id="loading" class="text-2xl text-valorant-text-secondary mt-12 animate-pulse">Loading Match History...</div>
    <div id="error" class="text-valorant-red text-xl text-center hidden mb-8"></div>

    <div id="matches-list" class="flex flex-col gap-4 w-full max-w-5xl p-2"></div>

    <div id="pagination-container" class="w-full max-w-5xl justify-center py-8 hidden">
        <button id="load-more-btn"
            class="p-2 bg-valorant-card border border-white/10 hover:border-valorant-red text-white font-bold uppercase tracking-widest rounded transition-all duration-300 hover:bg-valorant-red/10 active:scale-95 flex items-center gap-3">
            <span>Load More Matches</span>
            <div id="load-more-spinner"
                class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin hidden"></div>
        </button>
    </div>

    <div th:replace="~{fragments/modal :: match-details-modal}"></div>
    <div th:replace="~{fragments/scripts :: common-scripts}"></div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', async () => {
            const app = initApp();
            if (!app) return;
            if (app.error) {
                const errorEl = document.getElementById('error');
                const loadingEl = document.getElementById('loading');
                loadingEl.classList.add('hidden');
                errorEl.textContent = app.error;
                errorEl.classList.remove('hidden');
                return;
            }

            const { puuid, accessToken, entitlementsToken } = app;
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const listEl = document.getElementById('matches-list');
            const paginationContainer = document.getElementById('pagination-container');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const loadMoreSpinner = document.getElementById('load-more-spinner');
            const refreshBtn = document.getElementById('refresh-matches-btn');
            const refreshIcon = document.getElementById('refresh-icon');
            const refreshText = document.getElementById('refresh-text');
            const matchControls = document.getElementById('match-controls');

            let currentStartIndex = 0;
            const pageSize = 5;
            let isLoading = false;

            // Fetch Header Data
            fetchPlayerInfo(puuid, accessToken, entitlementsToken);
            fetchWallet(puuid, accessToken, entitlementsToken);

            const fetchMatches = async (start, end) => {
                if (isLoading) return;
                isLoading = true;

                if (start > 0) {
                    loadMoreSpinner.classList.remove('hidden');
                    loadMoreBtn.disabled = true;
                }

                try {
                    const responseHistory = await fetch(`/api/riot-valo/storefront/${puuid}/match-history?startIndex=${start}&endIndex=${end}`, {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Entitlements-Token': entitlementsToken,
                            'Region': 'ap'
                        }
                    });

                    if (!responseHistory.ok) {
                        throw new Error(`Failed to fetch Match History: ${responseHistory.status}`);
                    }

                    const jsonResponse = await responseHistory.json();
                    // Handle wrapped response
                    const data = jsonResponse.data || jsonResponse;
                    const matches = data.matches;

                    if (start === 0) {
                        loadingEl.classList.add('hidden');
                        matchControls.classList.remove('hidden');
                        listEl.innerHTML = ''; // Clear for fresh load if needed
                    } else {
                        loadMoreSpinner.classList.add('hidden');
                        loadMoreBtn.disabled = false;
                    }

                    if (!matches || matches.length === 0) {
                        if (start === 0) {
                            errorEl.textContent = 'No match history found.';
                            errorEl.classList.remove('hidden');
                        } else {
                            paginationContainer.classList.add('hidden');
                            paginationContainer.classList.remove('flex');
                        }
                        return;
                    }

                    renderMatches(matches);

                    // Update pagination state
                    currentStartIndex = data.endIndex;
                    if (currentStartIndex < data.total) {
                        paginationContainer.classList.remove('hidden');
                        paginationContainer.classList.add('flex');
                    } else {
                        paginationContainer.classList.add('hidden');
                        paginationContainer.classList.remove('flex');
                    }

                } catch (err) {
                    console.error(err);
                    if (start === 0) {
                        loadingEl.classList.add('hidden');
                        errorEl.textContent = 'Error loading matches: ' + err.message;
                        errorEl.classList.remove('hidden');
                    } else {
                        alert('Error loading more matches: ' + err.message);
                        loadMoreSpinner.classList.add('hidden');
                        loadMoreBtn.disabled = false;
                    }
                } finally {
                    isLoading = false;
                }
            };

            const renderMatches = (matches) => {
                matches.forEach(match => {
                    const card = document.createElement('div');
                    const isWin = match.result === 'VICTORY';
                    const isLoss = match.result === 'DEFEAT';
                    const borderColor = isWin ? 'border-green-500' : (isLoss ? 'border-red-500' : 'border-gray-500');
                    const bgColor = isWin ? 'bg-green-900/20' : (isLoss ? 'bg-red-900/20' : 'bg-gray-800/20');
                    const date = new Date(match.gameStartTime).toLocaleString();

                    let mvpBadge = '';
                    if (match.matchMVP) {
                        mvpBadge = '<span class="px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider bg-yellow-400 text-black shadow-lg border border-yellow-200/50">Match MVP</span>';
                    } else if (match.teamMVP) {
                        mvpBadge = '<span class="px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider bg-gray-200 text-black shadow-lg border border-white/50">Team MVP</span>';
                    }

                    card.className = `relative overflow-hidden flex flex-col md:flex-row items-center justify-between rounded-lg border-l-4 ${borderColor} bg-valorant-card shadow-md hover:shadow-xl transition-all duration-300 w-full group cursor-pointer active:scale-[0.98] mb-4 opacity-0 translate-y-4 animate-fade-in-up`;

                    card.onclick = (e) => {
                        if (e.target.closest('.match-id-copy')) return;
                        openMatchDetails(match);
                    };

                    card.innerHTML = `
                        <div class="absolute inset-0 bg-cover bg-center z-0 transition-transform duration-700 group-hover:scale-110 blur-[2px] brightness-[0.3]" style="background-image: url('${match.mapBg}');"></div>
                        <div class="absolute inset-0 z-0 ${bgColor} mix-blend-overlay"></div>
                        <div class="relative z-10 flex flex-col md:flex-row items-center justify-between w-full p-4">
                            <div class="flex items-center gap-4 w-full md:w-1/3 mb-4 md:mb-0">
                                <div class="relative w-16 h-16 shrink-0">
                                    <img loading="lazy" src="${match.agentIcon}" alt="${match.agentName}" class="w-full h-full object-cover rounded-full border-2 border-white/20 shadow-lg" onerror="this.src='https://placehold.co/64?text=?'">
                                    <div class="absolute -bottom-1 -right-1 bg-black/80 rounded text-xs px-2 py-0.5 text-white border border-white/20 shadow-sm">${match.agentName}</div>
                                </div>
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm md:text-lg font-bold text-white tracking-wide drop-shadow-md">${match.mapName}</span>
                                        <span class="text-[10px] bg-black/40 px-2 py-0.5 rounded text-gray-400 uppercase font-bold">${match.queueID}</span>
                                        ${mvpBadge}
                                    </div>
                                    <span class="text-[12px] text-gray-300 font-mono">${date}</span>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="match-id-copy text-[10px] font-bold text-gray-500 tracking-wider cursor-copy hover:text-white transition-colors truncate max-w-[120px]" onclick="event.stopPropagation(); navigator.clipboard.writeText('${match.matchId}'); const original = this.textContent; this.textContent='Copied!'; setTimeout(() => this.textContent=original, 1000);" title="Click to copy Match ID">${match.matchId || 'Unknown'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center w-full md:w-1/3 mb-4 md:mb-0">
                                <div class="text-2xl font-black tracking-widest ${isWin ? 'text-green-400' : (isLoss ? 'text-valorant-red' : 'text-gray-400')} drop-shadow-lg [text-shadow:0_2px_4px_rgba(0,0,0,0.5)]">${match.result}</div>
                                <div class="text-4xl font-black text-white my-1 drop-shadow-xl [text-shadow:0_2px_10px_rgba(0,0,0,0.8)]">${match.score}</div>
                                ${match.rankedRatingEarned !== null ? `
                                    <div class="text-sm font-bold ${match.rankedRatingEarned >= 0 ? 'text-green-400' : 'text-valorant-red'} mb-1 drop-shadow-md">
                                        ${match.rankedRatingEarned >= 0 ? '+' : ''}${match.rankedRatingEarned} RR
                                    </div>
                                ` : ''}
                                <div class="text-xs md:text-sm font-bold text-gray-400 uppercase tracking-widest bg-black/40 px-3 py-1 rounded-full backdrop-blur-sm border border-white/10 group-hover:border-white/30 transition-colors">Click for Scorecard</div>
                            </div>
                            <div class="flex items-center justify-end gap-3 w-full md:w-1/3">
                                 <div class="flex flex-col items-end">
                                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">KDA</span>
                                    <span class="text-sm md:text-lg font-bold text-white font-mono">${match.kda}</span>
                                 </div>
                                 <div class="w-px h-8 bg-white/10 mx-2"></div>
                                 ${match.rankName ? `
                                    <div class="text-right">
                                        <div class="text-sm md:text-lg font-bold text-white drop-shadow-md">${match.rankName}</div>
                                    </div>
                                     <img loading="lazy" src="${match.rankIcon}" alt="${match.rankName}" class="w-12 h-12 object-contain drop-shadow-lg" onerror="this.classList.add('hidden')">
                                 ` : `<div class="text-sm md:text-lg text-gray-400 italic font-bold uppercase tracking-widest">Unrated</div>`}
                            </div>
                        </div>
                    `;
                    listEl.appendChild(card);
                });
            };

            loadMoreBtn.onclick = () => {
                fetchMatches(currentStartIndex, currentStartIndex + pageSize);
            };

            refreshBtn.onclick = async () => {
                if (isLoading) return;

                refreshIcon.classList.add('animate-spin');
                refreshText.textContent = 'Refreshing...';
                refreshBtn.disabled = true;

                try {
                    const response = await fetch(`/api/riot-valo/match-history/${puuid}/refresh`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Entitlements-Token': entitlementsToken,
                            'Region': 'ap'
                        }
                    });

                    if (!response.ok) throw new Error('Refresh failed');

                    // Reset state and refetch
                    currentStartIndex = 0;
                    listEl.innerHTML = '';
                    matchControls.classList.add('hidden');
                    loadingEl.classList.remove('hidden');
                    errorEl.classList.add('hidden');

                    await fetchMatches(0, pageSize);
                } catch (err) {
                    console.error(err);
                    alert('Failed to refresh: ' + err.message);
                } finally {
                    refreshIcon.classList.remove('animate-spin');
                    refreshText.textContent = 'Refresh History';
                    refreshBtn.disabled = false;
                }
            };

            // Initial fetch
            fetchMatches(0, pageSize);
        });
    </script>
</body>

</html>
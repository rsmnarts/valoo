<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Valorant Match History')">
</head>
<body class="bg-valorant-base text-valorant-text-primary min-h-screen flex flex-col items-center p-5">

    <div th:replace="fragments/header :: header('Match History', false)"></div>

    <div id="loading" class="text-2xl text-valorant-text-secondary mt-12 animate-pulse">Loading Match History...</div>
    <div id="error" class="text-valorant-red text-xl text-center hidden"></div>
    <div id="matches-list" class="flex flex-col gap-4 w-full max-w-5xl p-2"></div>

    <script>
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('valorant_puuid');
            localStorage.removeItem('valorant_access_token');
            localStorage.removeItem('valorant_entitlements_token');
            window.location.href = '/?logout=true';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            let puuid = urlParams.get('puuid');
            const puuidStored = localStorage.getItem('valorant_puuid');
            
            const accessToken = localStorage.getItem('valorant_access_token');
            const entitlementsToken = localStorage.getItem('valorant_entitlements_token');
            
            if (!accessToken || !entitlementsToken) {
                window.location.href = '/?logout=true';
                return;
            }

            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const listEl = document.getElementById('matches-list');

            if (!puuid) {
                if (!puuidStored) {
                    errorEl.textContent = 'User ID (puuid) is missing.';
                    errorEl.style.display = 'block';
                    return;
                }
                puuid = puuidStored;
            }
             
            // Update back link
            const backLink = document.querySelector('a[href="/stores"]');
            if (backLink) {
                backLink.href = `/stores?puuid=${puuid}`;
            }

            try {
                // Fetch player name
                const responsePlayers = await fetch(`/api/riot-valo/players/${puuid}`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Entitlements-Token': entitlementsToken,
                        'Region': 'ap'
                    }
                });

                if (responsePlayers.ok) {
                    const jsonResponsePlayers = await responsePlayers.json();
                    const playerName = jsonResponsePlayers.data?.[0]?.GameName;
                    const playerTagline = jsonResponsePlayers.data?.[0]?.TagLine;

                    if (playerName && playerTagline) {
                        document.getElementById('player-name').textContent = playerName;
                        document.getElementById('player-tagline').textContent = '#' + playerTagline;
                    }
                }

                // Fetch Wallet
                try {
                    const responseWallet = await fetch(`/api/riot-valo/wallet/${puuid}`, {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Entitlements-Token': entitlementsToken,
                            'Region': 'ap'
                        }
                    });

                    if (responseWallet.ok) {
                        const jsonWallet = await responseWallet.json();
                        const balances = jsonWallet.Balances || jsonWallet.data?.Balances;
                        if (balances) {
                             const vp = balances["85ad13f7-3d1b-5128-9eb2-7cd8ee0b5741"] || 0;
                             const rp = balances["e59aa87c-4cbf-517a-5983-6e81511be9b7"] || 0;
                             const kc = balances["85ca954a-41f2-ce94-9b45-8ca3dd309006"] || 0;

                             document.getElementById('wallet-vp').textContent = vp.toLocaleString();
                             document.getElementById('wallet-rp').textContent = rp.toLocaleString();
                             document.getElementById('wallet-kc').textContent = kc.toLocaleString();
                             
                             const walletContainer = document.getElementById('wallet-container');
                             walletContainer.classList.remove('hidden');
                             walletContainer.classList.add('flex');
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch wallet:", e);
                }

                // Fetch Match History
                const responseHistory = await fetch(`/api/riot-valo/storefront/${puuid}/match-history`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Entitlements-Token': entitlementsToken,
                        'Region': 'ap'
                    }
                });
                
                if (!responseHistory.ok) {
                    throw new Error(`Failed to fetch Match History: ${responseHistory.status}`);
                }

                const jsonResponse = await responseHistory.json();
                const matches = jsonResponse.data?.matches; // Accessing wrapped response

                loadingEl.style.display = 'none';

                if (!matches || matches.length === 0) {
                    errorEl.textContent = 'No match history found.';
                    errorEl.style.display = 'block';
                    return;
                }

                matches.forEach(match => {
                    const card = document.createElement('div');
                    // Style based on result
                    const isWin = match.result === 'VICTORY';
                    const isLoss = match.result === 'DEFEAT';
                    const borderColor = isWin ? 'border-green-500' : (isLoss ? 'border-red-500' : 'border-gray-500');
                    const bgColor = isWin ? 'bg-green-900/20' : (isLoss ? 'bg-red-900/20' : 'bg-gray-800/20');
                    
                    const date = new Date(match.gameStartTime).toLocaleString();

                    card.className = `relative overflow-hidden flex flex-col md:flex-row items-center justify-between rounded-lg border-l-4 ${borderColor} bg-valorant-card shadow-md hover:shadow-lg transition-all duration-300 w-full group`;
                    
                    card.innerHTML = `
                        <!-- Background Layer -->
                        <div class="absolute inset-0 bg-cover bg-center z-0 transition-transform duration-700 group-hover:scale-110 blur-[3px] brightness-[0.25]" 
                             style="background-image: url('${match.mapBg}');">
                        </div>
                        <!-- Tint Layer -->
                        <div class="absolute inset-0 z-0 ${bgColor} mix-blend-overlay"></div>

                        <!-- Content Wrapper -->
                        <div class="relative z-10 flex flex-col md:flex-row items-center justify-between w-full p-4">
                            <div class="flex items-center gap-4 w-full md:w-1/3 mb-4 md:mb-0">
                                <div class="relative w-16 h-16 shrink-0">
                                    <img loading="lazy" src="${match.agentIcon}" alt="${match.agentName}" class="w-full h-full object-cover rounded-full border-2 border-white/20 shadow-lg" onerror="this.src='https://placehold.co/64?text=?'">
                                    <div class="absolute -bottom-1 -right-1 bg-black/80 rounded text-xs px-2 py-0.5 text-white border border-white/20 shadow-sm">${match.agentName}</div>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm md:text-lg font-bold text-white tracking-wide drop-shadow-md">${match.mapName}</span>
                                    <span class="text-[12px] text-gray-300 font-mono">${date}</span>
                                    <span class="text-[10px]  font-bold text-gray-400 tracking-wider mt-1 cursor-pointer hover:text-white transition-colors truncate max-w-[150px]" 
                                         onclick="navigator.clipboard.writeText('${match.matchId}'); this.textContent='Copied!'; setTimeout(() => this.textContent='${match.matchId}', 500);" 
                                         title="Click to copy Match ID">${match.matchId || 'Unknown'}</span>
                                </div>
                            </div>

                            <div class="flex flex-col items-center justify-center w-full md:w-1/3 mb-4 md:mb-0">
                                <div class="text-2xl font-black tracking-widest ${isWin ? 'text-green-400' : (isLoss ? 'text-valorant-red' : 'text-gray-400')} drop-shadow-lg" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">${match.result}</div>
                                <div class="text-4xl font-black text-white my-1 drop-shadow-xl" style="text-shadow: 0 2px 10px rgba(0,0,0,0.8);">${match.score}</div>
                                <div class="text-sm md:text-lg font-bold text-gray-300 tracking-widest bg-black/40 px-3 py-1 rounded-full backdrop-blur-sm border border-white/10">KDA: <span class="text-white">${match.kda}</span></div>
                            </div>

                            <div class="flex items-center justify-end gap-3 w-full md:w-1/3">
                                 ${match.ranked ? `
                                    <div class="text-right">
                                        <div class="text-sm md:text-lg  font-bold text-white drop-shadow-md">${match.rankName}</div>
                                    </div>
                                    <img loading="lazy" src="${match.rankIcon}" alt="${match.rankName}" class="w-12 h-12 object-contain drop-shadow-lg" onerror="this.style.display='none'">
                                 ` : `<div class="text-sm md:text-lg  text-gray-400 italic font-bold">Unrated</div>`}
                            </div>
                        </div>
                    `;
                    listEl.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Error loading matches: ' + err.message;
                errorEl.style.display = 'block';
            }
        });
    </script>
</body>
</html>

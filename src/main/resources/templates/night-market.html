<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Valorant Night Market')}">
</head>
<body class="bg-valorant-base text-valorant-text-primary min-h-screen flex flex-col items-center p-5">

    <div th:replace="~{fragments/header :: header('Night Market', true)}"></div>

    <div id="loading" class="text-2xl text-valorant-text-secondary mt-12 animate-pulse">Loading Night Market...</div>
    <div id="error" class="text-valorant-red text-xl text-center hidden"></div>
    <div id="weapons-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 w-full max-w-7xl p-2"></div>

    <div th:replace="~{fragments/modal :: video-modal}"></div>
    <div th:replace="~{fragments/scripts :: common-scripts}"></div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', async () => {
            const app = initApp();
            if (!app) return;
            if (app.error) {
                const errorEl = document.getElementById('error');
                const loadingEl = document.getElementById('loading');
                loadingEl.style.display = 'none';
                errorEl.textContent = app.error;
                errorEl.style.display = 'block';
                setTimeout(logout, 2000);
                return;
            }

            const { puuid, accessToken, entitlementsToken } = app;
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const gridEl = document.getElementById('weapons-grid');

            // Fetch Header Data
            fetchPlayerInfo(puuid, accessToken, entitlementsToken);
            fetchWallet(puuid, accessToken, entitlementsToken);

            try {
                const responseNightMarket = await fetch(`/api/riot-valo/storefront/${puuid}/night-market`, {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Entitlements-Token': entitlementsToken,
                        'Region': 'ap'
                    }
                });
                
                if (!responseNightMarket.ok) {
                    if (responseNightMarket.status === 401 || responseNightMarket.status === 403) {
                        logout();
                        return;
                    }
                    throw new Error(`Failed to fetch Night Market: ${responseNightMarket.status}`);
                }

                const jsonResponse = (await responseNightMarket.json())?.data;
                const skins = jsonResponse.items;
                const expireAt = jsonResponse.expireAt;
                
                if (expireAt) {
                    const countdownEl = document.getElementById('store-countdown');
                    const updateCountdown = () => {
                        const now = Math.floor(Date.now() / 1000);
                        let diff = expireAt - now;
                        if (diff <= 0) {
                            countdownEl.textContent = "EXPIRED";
                            return;
                        }
                        const days = Math.floor(diff / 86400); 
                        const hours = Math.floor((diff % 86400) / 3600);
                        const minutes = Math.floor((diff % 3600) / 60);
                        const seconds = diff % 60;
                        countdownEl.textContent = "Ends in: " + days + "d " + 
                            [hours, minutes, seconds].map(v => v < 10 ? "0" + v : v).join(":");
                    };
                    updateCountdown();
                    setInterval(updateCountdown, 1000);
                }

                loadingEl.style.display = 'none';

                if (!skins || skins.length === 0) {
                    errorEl.textContent = 'Night Market is not currently available or empty.';
                    errorEl.style.display = 'block';
                    return;
                }

                skins.forEach(skin => {
                    const card = document.createElement('div');
                    card.className = 'bg-valorant-card rounded overflow-hidden relative border border-white/10 hover:-translate-y-1 hover:shadow-2xl hover:border-valorant-red transition-all duration-300 group';
                    
                    const displayName = skin.displayName || 'Unknown Skin';
                    const displayIcon = skin.displayIcon || '';
                    const costIcon = skin.costIcon || 'https://media.valorant-api.com/currencies/85ad13f7-3d1b-5128-9eb2-7cd8ee0b5741/displayicon.png';
                    const originalCost = skin.originalCost || 'N/A';
                    const discountedCost = skin.discountedCost || 'N/A';
                    const discountPercent = skin.discountPercent ? Math.round(skin.discountPercent) : 0;
                    const videoUrl = skin.streamedVideo;

                    let videoButtonHtml = '';
                     if (skin.levels && skin.levels.length > 0) {
                        let buttons = '';
                        skin.levels.forEach((level, index) => {
                            if (level.streamedVideo) {
                                let btnLabel = 'L' + (index + 1);
                                const match = level.displayName?.match(/Level (\d+)/i);
                                if (match) btnLabel = 'L' + match[1];
                                buttons += `<button onclick="openVideo('${level.streamedVideo}')" class="inline-block mr-2 mb-2 w-6 h-6 flex items-center justify-center bg-white/5 border border-white/20 text-white text-xs font-bold hover:bg-valorant-red hover:border-valorant-red transition-all duration-200" title="${level.displayName || 'Level ' + (index + 1)}">${btnLabel}</button>`;
                            }
                        });
                        if (buttons) {
                             videoButtonHtml = `<div><p class="text-xs text-valorant-text-secondary uppercase mb-2 font-bold tracking-wider">Levels</p><div class="flex flex-wrap">${buttons}</div></div>`;
                        } else if (skin.streamedVideo) {
                           videoButtonHtml = `<button onclick="openVideo('${skin.streamedVideo}')" class="inline-block px-6 py-2 bg-valorant-red text-white text-sm md:text-lg font-bold uppercase tracking-wider hover:bg-red-700 transition-colors duration-300 rounded shadow-lg shadow-valorant-red/20">Watch Video</button>`;
                        }
                    } else if (videoUrl) {
                        videoButtonHtml = `<button onclick="openVideo('${videoUrl}')" class="inline-block px-6 py-2 bg-valorant-red text-white text-sm md:text-lg font-bold uppercase tracking-wider hover:bg-red-700 transition-colors duration-300 rounded shadow-lg shadow-valorant-red/20">Watch Video</button>`;
                    }

                    let chromaHtml = '';
                    if (skin.chromas && skin.chromas.length > 0) {
                        let swatches = '';
                        skin.chromas.forEach(chroma => {
                            if (chroma.swatch) {
                                swatches += `<img loading="lazy" src="${chroma.swatch}" alt="${chroma.displayName}" class="w-6 h-6 rounded border border-white/20 hover:border-valorant-red cursor-pointer transition-all duration-200" onclick="changeCardImage(this, '${chroma.displayIcon}')" title="${chroma.displayName}">`;
                            }
                        });
                        if (swatches) chromaHtml = `<div><p class="text-xs text-valorant-text-secondary uppercase mb-2 font-bold tracking-wider">Variants</p><div class="flex flex-wrap gap-2">${swatches}</div></div>`;
                    }

                    let tierHtml = skin.tier?.displayIcon ? `<img loading="lazy" src="${skin.tier.displayIcon}" class="absolute top-10 right-2 w-10 h-10 drop-shadow-md z-10" title="${skin.tier.displayName}">` : '';

                    card.innerHTML = `
                         <div class="absolute top-2 right-2 bg-yellow-400 text-black font-bold px-2 py-1 rounded shadow-lg z-20">-${discountPercent}%</div>
                        <div class="relative h-48 flex items-center justify-center p-6 group/img">
                            ${tierHtml}
                            <img loading="lazy" src="${skin.displayIcon}" alt="${skin.displayName}" class="card-main-image max-w-full max-h-full object-contain transition-all duration-500 group-hover:scale-110 drop-shadow-2xl" onerror="this.src='https://placehold.co/400x200?text=Weapon+Skin'">
                        </div>
                        <div class="p-5">
                            <div class="text-lg font-bold mb-2 uppercase text-valorant-text-primary tracking-wide leading-tight min-h-[3.5rem]">${displayName}</div>
                            <div class="flex items-center justify-between mt-2 mb-4 bg-black/20 p-2 rounded">
                                <span class="text-gray-400 line-through text-sm md:text-lg flex items-center decoration-red-500 decoration-2 line-through">
                                     <span class="w-4 h-4 mr-1 bg-gray-500 rounded-full flex items-center justify-center text-[10px] text-white font-bold opacity-50 mx-2"><img loading="lazy" src="${costIcon}" alt="vp" class="w-4 h-4"></span> ${originalCost}
                                </span>
                                <span class="text-white font-bold text-xl flex items-center text-green-400">
                                     <span class="w-5 h-5 mr-1 rounded-full flex items-center justify-center text-xs text-white font-bold mx-2"><img loading="lazy" src="${costIcon}" alt="vp" class="w-5 h-5"></span> ${discountedCost}
                                </span>
                            </div>
                            <div class="flex justify-between items-start gap-4 mt-4 min-h-[50px]">
                                <div class="flex-1">${chromaHtml}</div>
                                <div class="flex-1 flex justify-end">${videoButtonHtml}</div>
                            </div>
                        </div>
                    `;
                    gridEl.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Error loading Night Market: ' + err.message;
                errorEl.style.display = 'block';
            }
        });
    </script>
</body>
</html>
